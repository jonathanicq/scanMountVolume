# =============================================================================
# scanMountVolume - Docker Compose Configuration
# =============================================================================
# Usage:
#   ./deploy.sh development   # Development mode (dev branch)
#   ./deploy.sh production    # Production mode (master branch)
#
# Directory structure (code separate from data volumes):
#   /opt/app/code/         - Git repository (application source)
#   /opt/app/data/         - Persistent data (Docker volume)
#   /opt/app/logs/         - Application logs (Docker volume)
#   /opt/app/config/       - Configuration files (Docker volume)
# =============================================================================

services:
  scanmountvolume:
    build:
      context: .
      dockerfile: Dockerfile
      target: ${APP_ENV:-development}
    container_name: scanmountvolume
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8056}:8056"
    environment:
      - APP_ENV=${APP_ENV:-development}
      - APP_HOST=${APP_HOST:-0.0.0.0}
      - APP_PORT=${APP_PORT:-8056}
      - APP_SECRET_KEY=${APP_SECRET_KEY}
      - APP_DEBUG=${APP_DEBUG:-false}
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - AUTH_USERNAME=${AUTH_USERNAME:-admin}
      - AUTH_PASSWORD=${AUTH_PASSWORD}
      - SCAN_BATCH_SIZE=${SCAN_BATCH_SIZE:-1000}
      - SCAN_HASH_ALGORITHM=${SCAN_HASH_ALGORITHM:-sha256}
      - SCAN_WORKERS=${SCAN_WORKERS:-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - GIT_REPO_URL=${GIT_REPO_URL:-https://github.com/jonathanicq/scanMountVolume.git}
    volumes:
      # Mount network shares as read-only for scanning
      - /mnt:/mnt:ro
      # Persist data directories (separate from code directory)
      - scanmountvolume_data:/opt/app/data
      - scanmountvolume_logs:/opt/app/logs
      - scanmountvolume_config:/opt/app/config
    networks:
      - scanmountvolume_network
    # Health check disabled until application is implemented
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8056/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s

volumes:
  scanmountvolume_data:
    driver: local
  scanmountvolume_logs:
    driver: local
  scanmountvolume_config:
    driver: local

networks:
  scanmountvolume_network:
    driver: bridge
